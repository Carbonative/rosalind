# Circle CI tests and deploys the server component (Meteor)

machine:
  java:
    version: oraclejdk8

  node:
    version: 0.12.7

dependencies:
  override:
    - if [ -d ~/.meteor ]; then sudo ln -s ~/.meteor/meteor /usr/local/bin/meteor; fi
    - if [ ! -e ~/.meteor/meteor ]; then curl https://install.meteor.com | sh; fi
    - npm install

  cache_directories:
    - "node_modules"
    - "~/.npm"
    - "~/.meteor"
    - "app/meteor/.meteor/local/build"
    - "app/meteor/.meteor/local/bundler-cache"
    - "app/meteor/.meteor/local/db"
    - "app/meteor/.meteor/local/isopacks"
    - "app/meteor/.meteor/local/plugin-cache"
    - "app/meteor/.meteor/local/mirrors"

test:
  pre:
    - mkdir -p $CIRCLE_TEST_REPORTS/cucumber

  override:
    - npm test
        environment:
          CUCUMBER_JSON_OUTPUT: "$CIRCLE_TEST_REPORTS/cucumber/chrome.cucumber"

deployment:
  master:
    branch: master
    owner: albertzak
    commands:
      - chmod +x ./environments/production/deploy.sh
      - ./environments/production/deploy.sh
